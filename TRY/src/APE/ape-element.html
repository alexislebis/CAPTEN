<link rel="import" href="../wrapper/ape-model-element.html">
<link rel="import" href="./steps/step-editor-element.html">

<link rel="import" href="./operators/operators-workzone-element.html">


<dom-module id="ape-element">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <div id="rgteMenuBar">
      <h3>RGTE Menu bar</h3>
      <template id="rgtesMenuBar" is="dom-repeat" items="[[rgtes]]" index-as="index">
        <div>
          <rgte-displayer-element id$="{{_generateRGTEID(index)}}" rgte="{{item}}" on-tap="_rgteClicked"></rgte-displayer-element>
        </div>
      </template>
    </div>

    <ape-model-element></ape-model-element>

    <step-editor-element id="stepEditor"></step-editor-element>

    <operators-workzone-element id="opWorkzone" currentoperator="{{currentoperator}}" vocab="{{vocab}}" customcls="{{customcls}}" customprops="{{customprops}}"></operators-workzone-element>

    <h1>
      APE nÂ°<span style="color:green">[[name]]</span>
    </h1>
  </template>
  <script>
    Polymer({
      is: 'ape-element',

      properties: {

        /**
         * Useless var.
         *
         * @attribute name
         * @type String
         */
        name: {
          type: String,
          notify: true,
          value: "78795685"
        },

        //RGTEs is an Array of RGTE. AN RGTE is a vis network associated with its edgesCardinality like:
        //[{network: network, card: edgesCardinality},]
        rgtes:{
          type: Array,
          notify: true,
          value: function(){return [];},
        },


        vocab:
        {
          type: Object,
        },
        customcls://used for file-reader
        {
            type: Array,
            notify: true,
        },
        customprops:
        {
            type: Array,
            notify: true,
        },
        currentoperator:
        {
          type: Object,
          notify: true,
          observer: '_currentOperatorOnChanged',
        },
        //
        // operators:{
        //   type: Array,
        //   notify: true,
        //   value: function(){return [];},
        // },

      },

      observers:
      [
        "_onRGTESChanged(rgtes.splices)",
      ],

      ready: function()
      {

      },

      attached: function()
      {
        this._observer=Polymer.dom(this.$.rgteMenuBar).observeNodes(function(info)
        {
          var div = this._findNewRGTEDiv(info.addedNodes);
          if(div != null)
          {
            this.$$("#"+div).draw();
          }
        }.bind(this));
      },

// === EVENTS
      _onRGTESChanged: function(change)
      {
        if(change == null)
          return;


          console.log(this.$$('#rgte'+i));
        var i = 0;
        while(this.$$('#rgte'+i) != null)
        {
          this.$$('#rgte'+i).draw();
          i++;
        }
      },

      _rgteClicked: function(e)
      {
        var rgteIndex = parseInt(Polymer.dom(e).localTarget.id.split('rgte')[1]);
        console.log(rgteIndex);
      },

      _currentOperatorOnChanged: function()
      {
        if(this.currentoperator == null)
          return;

        this.$.stepEditor.changeOperator(this.currentoperator);
      },
// ===

      _generateRGTEID: function(index)
      {
        console.log(index)
        return "rgte"+index;
      },

      _findNewRGTEDiv: function(info)
      {
        for(var j = 0; j < info.length; j++)
        {
          for(var i in info[j].childNodes)
          {
            if(info[j].childNodes[i].id != null && info[j].childNodes[i].id.includes('rgte'))
            {
              return info[j].childNodes[i].id;
            }
          }
        }

        return null;
      },

    });
  </script>
</dom-module>
