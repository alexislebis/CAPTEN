<link rel="import" href="./operation-displayer-element.html">

<dom-module id="operation-search-element">
  <template>
    <style>

    #searchZone{
      @apply(--layout-horizontal);
      margin-bottom: 50px;
    }

    #searchZone paper-searchbox{
      @apply(--layout-flex);
      --paper-searchbox-background: var(--paper-searchbox-dark-background);
      --paper-searchbox-color: black;
    }

    #divRoot{
      width: 60%;
      margin: 0 auto;
    }

    #new{
      @apply(--layout-vertical);
      @apply(--layout-center);
      margin-bottom: 50px;
    }

    </style>

    <app-location route="{{routeTopLevel}}" use-hash-as-path></app-location>

<div id="divRoot">

  <div id="fabRewind" hidden$={{!enableRewind}}>
    <paper-fab icon="icons:reply" on-click="_goBack"></paper-fab>
  </div>

  <div id="new">
    <paper-button raised on-click="_openNew">Create a new narrated operator</paper-button>
  </div>

    <div id="searchZone" hidden="{{_computeHiddenAssumption(itemElmt)}}">
      <paper-searchbox raise-forced="true" placeholder="Search operation" value="{{query}}"></paper-searchbox>
      <paper-button raised disabled>Show search options</paper-button>
    </div>

  <div id="result">
    <div id="normal">
      <header class="headerSubSection">
        <div><span><h3>{{_computeHeaderName(query)}}</h3></span></div>
      </header>
  <!--  -->
    <template id="repeater" is="dom-repeat" items="{{operationsArray}}" filter="{{computeFilter(query, unproposed)}}" index-as="index" restamp>
      <operation-displayer-element enable-use="{{enableUse}}" operator="{{item}}"></operation-displayer-element>
    </template>
    </div>
    <div id="previous">
      <header class="headerSubSection">
        <div><span>Previous operations used</span></div>
      </header>
    </div>
    <div>
      <header class="headerSubSection">
        <div><span>Suggested operations</span></div>
      </header>
    </div>

    (note:lier nop avec voc pour leur type pour emergence des relations)
  </div>
</div>

  </template>
  <script>
    Polymer(
    {
      is: 'operation-search-element',

      properties:{
        operationsArray:
        {
          type: Object,
          notify: true,
        },

        routeTopLevel: Object,

        query : String,

        enableRewind:
        {
          type: Boolean,
          value: false,
          notify: true,
        },

        toStack:
        {
          type: Object,
          notify: true,
        },

        unproposed:
        {
          type: Array,
          notify: true,
        }
      },

      observers: [
        "_onUnproposedChanged(unproposed.*)",
      ],

      _openNew: function()
      {
        // HISTORY_MANAGER.stack(this.toStack);
        this.set('routeTopLevel.path', '/nop/new');
      },

      // _onRouteChanged: function(route)
      // {
      //   if(route.path != "/operation_search")
      //     return null;
      //
      //
      //   //@HACK force dom repeat redraw
      //   this.operationsArray = [];
      //   this.$.repeater.render();
      //   //===
      //
      //   this.operationsArray = NARRATED_OPERATION_POOL.getAvailableOperations();
      //
      //   this.$.repeater.render();
      //
      // },
      //
      attached: function()
      {
        //@HACK force dom repeat redraw
        this.operationsArray = [];
        // this.$.repeater.render();
        //===

        this.operationsArray = NARRATED_OPERATION_POOL.getAvailableOperations();

        // this.$.repeater.render();
      },

      _onUnproposedChanged: function(e)
      {
        // this.$.repeater.render();
      },

      update: function()
      {
        //@HACK force dom repeat redraw
        this.operationsArray = [];
        this.$.repeater.render();
        //===

        var unp = this.unproposed;
        this.unproposed = [];
        this.unproposed = unp;

        this.set('operationsArray',NARRATED_OPERATION_POOL.getAvailableOperations());

        // this.$.repeater.render();
      },

      computeFilter: function(query, unproposed)
      {
        if((!query || query == null) && this.unproposed.length == 0)
          return null;
        else {
          query = query.toLowerCase();
          // TODO REDO homogenisation with narrative name element
          return function(item){

            for(var i in unproposed)
            {
              if(unproposed[i] && unproposed[i].id == item.id)
                return false;
            }

            if(item == null)
              return;

            var behavior = (item instanceof NarratedOperator) ? 0 : 1;

            if(behavior == 0)
            {
              return (item.usualName.toLowerCase().includes(query));
            }
            else
            {
              return (item.name.toLowerCase().includes(query));
            }
          };
        }
      },

      _updateOperationsArray: function()
      {
        // this.operationsArray = [];
        // this.set('operationsArray', NARRATED_OPERATION_POOL.getAvailableOperations());
      },

      _computeHeaderName: function(query)
      {
        return query.length == 0 ? 'Operations' : 'Search results';
      },

      _goBack: function()
      {
        this.fire(OPERATION_REWIND_REQUESTED_SIGNAL_ID);
      },

    });
  </script>
</dom-module>
