<link rel="import" href="../operation-step-display-element.html">

<dom-module id="step-creation-page-element">
  <template>
    <style>
      :host{
        --rgte-common-width: 100%;
        --vis-element-width: 100%;
      }
    </style>

<app-route route="{{route}}" pattern="/:itemValue" active="{{active}}" data="{{data}}" tail="{{tail}}"></app-route>

<div id="divRoot">

  <header>
    <h2> <span hidden$={{!isNew}}>New </span>Step</h2>
    <div id="paperFabs">
      <!-- <paper-fab icon="av:fiber-new" disabled="{{isNew}}" on-click="_openVocabularyNewItemPage"></paper-fab> -->

    </div>
    <paper-input id="nameNOP" label="Narrated operator name" value="{{stepName}}" char-counter required maxlength="100"></paper-input>
  </header>

  <div id="narrativeInfo">
    <div id="generalInformation">
      <header>
        <h4>General Information</h4>
      </header>
      <div id="gIContent" class="narrativeContent">
        <paper-input id="objectif1Step" label="The step's objective (#1)" value="{{stepobjectif1}}" char-counter maxlength="100"></paper-input>
      </div>
    </div>
    <div id="otherNarrative">
      <header>
        <h4>Other Narrative Information</h4>
      </header>
      <div id="oNIContent" class="narrativeContent">
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Mauris varius, est id ultrices lobortis, magna dolor aliquet ligula, non mollis augue turpis in nulla. Donec sit amet dui ornare, tempus nibh nec, pharetra tellus. Aliquam metus ex, convallis a tincidunt nec, tempus sit amet quam. Nullam at pellentesque tellus. Ut sollicitudin maximus lorem ac porttitor. Vivamus fringilla viverra nisl ut ultrices. Morbi aliquet sem lectus, sed malesuada velit facilisis sit amet. Donec volutpat, nunc quis ultrices aliquam, velit ante convallis purus, et malesuada mauris est accumsan magna. Vivamus nec nibh non arcu finibus posuere sed eget turpis. Interdum et malesuada fames ac ante ipsum primis in faucibus.
      </div>
    </div>
  </div>


  <div id="separator"></div>

  <div id="configurationZone">

<!-- CONFIGURATION ZONE  -->

    <header>
      <h4>Representation of its behavior<br/>(How it is supposed to work in a general way)</h4>
    </header>

    <div id="stepState">
      <h3 id="stateTitle">Step State</h3>
      <div id="stepStateError">
        <div id="sSEHead">
          <h4 class="title">Error to solve before completing the step</h4>
        </div>
        <div id="sSESubDiv">
        </div>
      </div>
      <div id="stepStateLinking">
        <div id="sSLHead">
          <h4 class="title">@removeInputs concepts to Operator linkage</h4>
        </div>
        <div id="sSLSubDiv">

        </div>
      </div>
      <div id="identifK">
        <h4 class="title">@removeIdentify knowledge concepts</h4>
        <paper-fab id="kFab" icon="image:brush" on-tap="_toggleKnowledgeIdentification">
      </div>

      <div>
        <paper-fab icon="icons:settings-input-component" on-click="_toggleRelationMode"></paper-fab>
      </div>
    </div>

    <vaadin-split-layout>
      <vaadin-split-layout>
        <div>
          <h2>Input</h2>
          <neon-animated-pages selected='{{inputSection}}'
                           attr-for-selected='name'
                           entry-animation='scale-up-animation'
                           exit-animation='slide-right-animation'>

             <neon-animatable name='searchInput'><rgte-search-element id="rsei" enable-rewind="{{_computeRewindAuthorized(input)}}" enable-use="true"></rgte-search-element></neon-animatable>
             <neon-animatable name='inputZone'><rgte-workzone-element id="rwei" rgte="{{input}}" enable-use disable-edit vocab="{{vocab}}" customcls="{{customcls}}" customprops="{{customprops}}"></rgte-workzone-element></neon-animatable>

          </neon-animated-pages>

        </div>
        <div>
          <h2>Operation</h2>
          <neon-animated-pages selected='{{operationSection}}'
                           attr-for-selected='name'
                           entry-animation='scale-up-animation'
                           exit-animation='slide-right-animation'>

             <neon-animatable name='searchOperation'><operation-search-element id="ose" enable-rewind="{{_computeRewindAuthorized(operation)}}" enable-use="true"></operation-search-element></neon-animatable>
             <neon-animatable name='operationZone'><operation-step-display-element id="osde" operation="{{operation}}" vocab="{{vocab}}" customcls="{{customcls}}" customprops="{{customprops}}"></operation-step-display-element></neon-animatable>

          </neon-animated-pages>
        </div>
      </vaadin-split-layout>
        <div>
          <h2>Output</h2>
          <rgte-workzone-element id="inputElement" rgte="{{output}}" disable-edit="{{disableEdit}}" vocab="{{vocab}}" customcls="{{customcls}}" customprops="{{customprops}}"></rgte-workzone-element>
        </div>
    </vaadin-split-layout>

    <div id="graphsRelations">
      Tableau de relations ici.
      Intégrer les relations avec les éléments narratifs.
      Rajouter un color picker à la fin de la ligne.
    </div>

<!-- END CONFIGURATION ZONE  -->

  </div>
</div>
  </template>
  <script>
    Polymer(
    {
      is:"step-creation-page-element",


      properties:
      {
        route:
        {
          type: Object,
          notify: true,
        },

        step:
        {
          type: Object,
          value: function(){return new Step();},
          notify: true,
        },

        operation:
        {
          type: Object,
          notify: true,
        },

        input:
        {
          type: Object,
          notify: true,
        },

        output:
        {
          type: Object,
          notify: true,
        },

        // === Page
        operationSection:
        {
            type: String,
            value: "searchOperation",
            notify: true,
        },
        operationSectionStack: // Used to remember the user navigation. Usefull?
        {
          type: Array,
          value: function(){return [];},
          notify: true,
        },
        inputSection:
        {
          type: String,
          value: "searchInput",
          notify: true,
        },
        // === EndPage

        relationModeI_NOP: //used for linking input with nop
        {
          type: Boolean,
          value: false,
          notify: true,
        },

        vocab:
        {
          type: Object,
          value: function(){ return new CONTROLLED_VOCABULARY();},
        },
        customcls://used for file-reader
        {
            type: Array,
            notify: true,
            value: function()
            {
                return [];
            },
        },
        customprops:
        {
            type: Array,
            notify: true,
            value: function()
            {
                return [];
            },
        },
      },

      observers: [
        "_onRouteChanged(route)",
      ],

      attached: function()
      {
        //@TODO  + deferencing into narrativeblock iff chang

        // === INPUT
        this.$.rsei.addEventListener(RGTE_USE_FROM_SEARCH_SIGNAL_ID, function(e){
          this._loadInputPage(e.detail.rgte);
        }.bind(this));

        this.$.rsei.addEventListener(RGTE_REWIND_REQUESTED_SIGNAL_ID, function(e)
        {
          this._loadInputPage(this.input);
        }.bind(this));

        this.$.rwei.addEventListener(RGTE_REPLACEMENT_REQUESTED_SIGNAL_ID, function(e){
          this._loadSearchInputPage();
        }.bind(this));

        this.$.rwei.addEventListener('NODE_CLICKED', function(e){
          this._behaviorManager(e.detail);
        }.bind(this));

        // === NOP
        this.$.ose.addEventListener(OPERATION_USE_FROM_SEARCH_SIGNAL_ID, function(e){
          this._loadOperationPage(e.detail.operation);
        }.bind(this));

        this.$.ose.addEventListener(OPERATION_REWIND_REQUESTED_SIGNAL_ID, function(e){
          this._loadOperationPage(this.operation);
        }.bind(this));

        this.$.osde.addEventListener(STEP_OPERATION_REPLACEMENT_REQUESTED_SIGNAL_ID, function(e){
          this._loadSearchOperationPage();
        }.bind(this));

        this.$.osde.addEventListener(OPERATION_INPUT_PATTERN_NODE_CLICKED_SIGNAL_ID, function(e){
          this._behaviorManager(e.detail);
        }.bind(this));


        // === OUTPUT
        this.step.registerObserverCallbackOnOutputsComputation(this, this._outputComputed);
      },

      // === RESET behaviors
      reset: function()
      {
        //todo reattacher listener sur nouvelle step
      },

      _behaviorManager: function(obj)
      {
        if(this.relationModeI_NOP)
        {
          this.step.bindRGTENOP(obj);
        }
        else // default behaviors : nothing to do
        {
          return;
        }
      },

    // === INPUT page
      _loadInputPage: function(rgte)
      {
        this.input = rgte;
        this.step.changeRGTE(this.input);
        this.inputSection = "inputZone";
      },

      _loadSearchInputPage: function()
      {
        this.inputSection = "searchInput";
      },
    // === END Input Page
    // === NOP page Dedicated Function
      _loadOperationPage: function(operation)
      {
        this.operation = operation;
        this.step.changeOperator(this.operation);
        this.operationSection = "operationZone";
      },

      _loadSearchOperationPage: function()
      {
        this.operationSection = "searchOperation";
      },
    // === END NOP page Dedicated function

      _onRouteChanged: function(route)
      {
        if(route.prefix.toLowerCase() != "/step")
          return;

        this.$.rsei.update();
        this.$.ose.update();
      },

      _computeRewindAuthorized: function(operation)
      {
        return operation == null ? "false" : "true";
      },

      _toggleRelationMode: function()
      {
        this.relationModeI_NOP = !this.relationModeI_NOP;
        return;
      },

      _outputComputed: function()
      {
        this.output = this.step.outputs;
      },

    });
  </script>
</dom-module>
