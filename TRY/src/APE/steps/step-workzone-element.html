<link rel="import" href="./step-editor-element.html">
<link rel="import" href="./steps-displayer-element.html">

<dom-module id="step-workzone-element">
  <template>
    <style include="toasty-style"></style>
    <style>
    </style>

    <div id="newStep">
      <p>
          Create new a step paper: <paper-icon-button on-click="_createNewStep" icon="icons:add-box"></paper-icon-button>
      </p>
    </div>

    <div id="openEditor">
      <p>
          Open step editor for the step current step <paper-icon-button icon="icons:open-in-new" on-click="_openEditorNewStep"></paper-icon-button>
      </p>
    </div>

    <!-- <div hidden="{{!isStepEditionEnabled}}"> -->
    <div id="stepEditionDiv">
      <template id="refreshEditor" is="dom-if" if="{{isStepEditionEnabled}}" restamp>
        <step-editor-element id="stepEditor" step="{{cstep}}" vocab="{{vocab}}" customcls="{{customcls}}" customprops="{{customprops}}"></step-editor-element>
      </template>
    </div>

    <div id="stepsDisplayerDiv">
      <h3>Steps Displayer</h3>
      <steps-displayer-element id="stepsDisplayer" steps="{{steps}}"></steps-displayer-element>
    </div>


    <paper-toast id="toastNewStep" text="Step created">
      <paper-button on-click="_rollbackNewStep" class="toastButton">UNDO</paper-button>
    </paper-toast>

    <paper-toast id="toastNoStepSelected" text="No step selected"></paper-toast>

    <paper-toast id="toastUseNOP" text="Operator used in the current step">
      <!-- <paper-button on-click="_rollbackNewOP" class="toastButton">UNDO</paper-button> -->
    </paper-toast>


    <paper-toast id="toasOpenStepPane" text="Step workzone is currently closed">
      <paper-button on-click="_openEditorNewStep" class="toastButton">OPEN</paper-button>
    </paper-toast>


  </template>
  <script>
    Polymer(
      {
        is: 'step-workzone-element',

        properties:
        {
          vocab:
          {
            type: Object,
          },
          customcls://used for file-reader
          {
              type: Array,
              notify: true,
          },
          customprops:
          {
              type: Array,
              notify: true,
          },


          rgtes://PROVENANCE ape-elements
          {
            type: Array,
            value: function(){return [];},
            notify: true,
          },

          steps:
          {
            type: Array,
            value: function(){return [];},
            notify: true,
          },

          cstep:
          {
            type: Object,
            // value: function(){return new Step();},
            notify: true,
          },
          isStepEditionEnabled:
          {
            type: Boolean,
            value: false,
            notify: true,
          },

          stepEditorReference:
          {
            type: Object,
            value: null,
            notify: true,
          },

          // === TOASTY
          //For rollback
          rollbackStep:
          {
            type: Object,
            notify: true,
          },
          tmpOp:
          {
            type: Object,
            notify: true,
          },
        },

        //TODO use prop belongsTo

        // ===NATIVE
        attached: function()
        {

          // this.$.stepEditor.addEventListener("-CreateNewStep", function(e){
          //    this.createNewStep();
          //  }.bind(this));
          //
          //  this.$.stepEditor.addEventListener("-OutputRecomputed", function(e){
          //    this.push('rgtes', e.detail.step.outputs);
          //  }.bind(this));
          //
          //  this.$.stepEditor.addEventListener("-ReturnToWorkzone", function(e){
          //    this._hiddeStepEditor();
          //  }.bind(this));

          this.$.stepsDisplayer.addEventListener("-STEPS_DSP_NODE_CLICKED", function(e)
          {
            if(TOOL_EVENT.isCtrlLeftClick(e.detail.event))
              this._notifyStepNarrativeBlock(e.detail);
            else
              this._updateCurrentStep(e.detail);
          }.bind(this));

          this._observer = Polymer.dom(this.$.stepEditionDiv).observeNodes(function(info)
          {
            for(var i in info.addedNodes)
            {
              if (info.addedNodes[i] != null && info.addedNodes[i].localName === 'step-editor-element')
              {
                this.stepEditorReference = info.addedNodes[i];
                info.addedNodes[i].addEventListener("-CreateNewStep", function(e){
                  this.createNewStep();
                }.bind(this));

                info.addedNodes[i].addEventListener("-OutputRecomputed", function(e){
                  this.push('rgtes', e.detail.step.outputs);
                }.bind(this));

                info.addedNodes[i].addEventListener("-ReturnToWorkzone", function(e){
                  this._hiddeStepEditor();
                }.bind(this));

              }
            }
          }.bind(this));
        },

        // === NARRATIVE BLOCK NOTIFICATION
        _notifyStepNarrativeBlock: function(param)
        {
          for(var i in this.steps)
            if(this.steps[i].id == param.id)
            {
              NARRATIVE_BLOCK_NOTIFY_SIGNAL_BUILDER(this, this.steps[i], param);
              return true;
            }
        },

        // === PUBLIC


        // === EVENTS
        useRGTE: function(rgte) //Receive rgte and forward to the step editor iff it is active
        {
          if(rgte == null)
            return;

          if(this.stepEditorReference == null)
          {
            console.error("EDITION MODE IS NOT ENABLED FOR THE STEP. RGTE IS DISCARDED.");
            return;
          }

          this.stepEditorReference.changeRGTE(rgte);
          this._updateDisplayer();
        },

        useOperator: function(op) //Receive rgte and forward to the step editor iff it is active
        {
          if(op == null)
            return;

          if(this.stepEditorReference == null)
          {
            console.error("EDITION MODE IS NOT ENABLED FOR THE STEP. OPERATOR IS DISCARDED.");
            this.tmpOp = op;
            this.$.toasOpenStepPane.open();
            return;
          }

          this.$.toastUseNOP.open();//Need to be before this.stepEditorReference, otherwise last toast displayed is "correctly added"
          this.stepEditorReference.changeOperator(op);

        },

        // === PRIVATE

          // _updateStepsDependencies: function()//Compute the dependecies of the step between them
          // {
          //   for(var i in this.steps)
          //   {
          //     this._stepDependencies(this.steps[i]);
          //   }
          // },
          //
          // _stepDependencies: function(step)
          // {
          //   for(var i in this.steps)
          //   {
          //     if(this.steps[i].outputs.id == step.inputs.id)
          //       return new Property(FOLLOWED_BY_URI, "followed by", this.steps[i].id, this.step[i]);
          //   }
          // },

        _updateCurrentStep: function(p)
        {
          for(var i in this.steps)
          {
            if(this.steps[i].id == p.id)
            {
              var prevState = this.isStepEditionEnabled;
              this.isStepEditionEnabled = false;

              this.cstep = this.steps[i];

              console.log(this.cstep);
              return;
            }
          }
        },

        _createNewStep: function()
        {
          this.cstep = new Step();
          this.rollbackStep = this.cstep;

          this.push('steps', this.cstep);

          this.isStepEditionEnabled = false;
          // this.isStepEditionEnabled = true;
          this.$.toastNewStep.open();
          this._updateDisplayer();
        },

        _updateDisplayer: function()
        {
          this.$.stepsDisplayer.draw(this.steps);
        },

        _hiddeStepEditor: function()
        {
          this.isStepEditionEnabled = false;
        },

        _openEditorNewStep: function()
        {
          if(this.cstep == null)
          {
            this.$.toastNoStepSelected.open();
            return;
          }
          this.isStepEditionEnabled = true;
        },

        _toastOpenEditorNewStep: function()
        {
          this._openEditorNewStep();
          this.useOperator(this.tmpOp);
          this.tmpOp = null;
        },

        _rollbackNewStep: function()
        {
          if(this.rollbackStep == null)
            return;

          var index;
          for(var i in this.steps)
            if(this.steps[i].id == this.rollbackStep)
              index = i;

          this.splice('steps', index, 1);

          this.cstep = null;
          this.rollbackStep = null;
          this._updateDisplayer();
        },

      });
  </script>
</dom-module>
