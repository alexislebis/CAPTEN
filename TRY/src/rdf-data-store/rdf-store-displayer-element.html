<link rel="import" href="../wrapper/rdfstore-element.html">
<link rel="import" href="../wrapper/vis-element.html">

<dom-module id="rdf-store-displayer-element">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        <vis-element id="rdfDisplay"></vis-element>
    </template>
    <script>
        (
            function()
            {
                var domainURI = ["http://www.w3.org/2000/01/rdf-schema#domain"];
                var rangeURI = ["http://www.w3.org/2000/01/rdf-schema#range"];
                var dumpedURI = ["http://www.w3.org/2002/07/owl#Class",
                    "http://www.w3.org/2002/07/owl#ObjectProperty",
                    "http://www.w3.org/1999/02/22-rdf-syntax-ns#type"
                ];

                Polymer(
                {
                    is: 'rdf-store-displayer-element',

                    properties:
                    {
                        rdfclasses:
                        {
                            type: Array,
                            notify: true,
                        },

                        rdfprops:
                        {
                            type: Array,
                            notify: true,
                        },
                        store:
                        {
                            type: Object,
                            notify: true,
                            value: function()
                            {
                                return {};
                            },
                        },
                        graphuri:
                        {
                            type: Object,
                            notify: true,
                            value: function()
                            {
                                return {};
                            },
                        },
                        graph:
                        {
                            type: Object,
                            notify: true,
                            value: function()
                            {
                                return {};
                            },
                        },
                    },

                    generateGraph: function()
                    {
                        var headQuery = "SELECT ?s ?o { ?s '<";
                        var tailQuery = ">' ?o }";
                        // var q2  = "CONSTRUCT { <"+this.classes[0]+"> ?p ?o } \
                        //            WHERE { <"+this.classes[0]+"> ?p ?o  }";

                        var defaultGraph = [];
                        var namedGraphs = [
                        {
                            'token': 'uri',
                            'value': this.graphuri
                        }];
                        var visDisplay = this.$.rdfDisplay;

                        var properties = [];

                        var that = this;

                        this.graph.triples.forEach(function(elm)
                        {
                            if (!this.propertieIsParsed(elm.subject.nominalValue, properties))
                            {
                                properties[elm.subject.nominalValue] = [
                                    [],
                                    []
                                ];
                            }
                            if (this.rdfprops.includes(elm.subject.nominalValue))
                            {
                                //console.log(elm.subject.nominalValue + "----" + elm.predicate.nominalValue + "--->" + elm.object.nominalValue);
                                // if (!this.propertieIsParsed(elm.subject.nominalValue, properties))
                                // {
                                //     properties[elm.subject.nominalValue] = [
                                //         [],
                                //         []
                                //     ];
                                // }

                                if (this.isDomain(elm.predicate.nominalValue))
                                {
                                    if (this.rdfclasses.includes(elm.object.nominalValue))
                                        properties[elm.subject.nominalValue][0].push(elm.object.nominalValue);
                                }
                                else if (this.isRange(elm.predicate.nominalValue))
                                {
                                  if (this.rdfclasses.includes(elm.object.nominalValue))
                                      properties[elm.subject.nominalValue][1].push(elm.object.nominalValue);
                                }
                                //   if(!this.belongsToForbiden(elm.predicate.nominalValue) && !this.belongsToForbiden(elm.object.nominalValue))
                                //   {
                                //     console.log();
                                //     visDisplay.createEdgeBetween(elm.subject.nominalValue, elm.object.nominalValue, elm.predicate.nominalValue);
                                //   }
                            }
                            else if (this.rdfclasses.includes(elm.subject.nominalValue)) {
                              if(!this.belongsToForbiden(elm.predicate.nominalValue))
                                visDisplay.createEdgeBetween(elm.subject.nominalValue, elm.object.nominalValue, elm.predicate.nominalValue);
                            }

                        }.bind(this));

                        this._addNodes(this.rdfclasses);
                        this._addEdges(properties);

                        visDisplay.redrawNetwork();

                        // this.rdfclasses.forEach(function(elm)
                        // {
                        //     visDisplay.addNode(elm, elm);
                        // });
                        //
                        //
                        // // this.rdfprops.forEach(function(elm)
                        // // {
                        // elm = this.rdfprops[0];
                        //     var query = headQuery + elm + tailQuery;
                        //
                        //     //visDisplay.addNode(elm, elm);
                        //
                        //     console.log(query);
                        //     that.store.execute(query, function(err, results)
                        //     {
                        //         if (!err)
                        //         {
                        //             var fromCls;
                        //             var toCls;
                        //             var fromToArray = [];
                        //
                        //             console.log(results);
                        //             results.forEach(function(element)
                        //             {
                        //
                        //                 if (element.o.token === 'uri' && element.s.token === 'uri')
                        //                 {
                        //                     // console.log(element.s.value + " ---->" + element.o.value);
                        //                     //   visDisplay.createEdgeBetween(element.s.value, element.o.value, elm);
                        //
                        //                     if (that.rdfclasses.includes(element.s.value))
                        //                     {
                        //                         fromCls = element.s.value;
                        //                         console.log(fromCls);
                        //                     }
                        //                     if (that.rdfclasses.includes(element.o.value))
                        //                     {
                        //                         toCls = element.o.value;
                        //                         console.log(toCls);
                        //                     }
                        //
                        //                 }
                        //
                        //                 if (fromCls != undefined && toCls != undefined)
                        //                 {
                        //                     fromToArray.push(
                        //                     {
                        //                         from: fromCls,
                        //                         to: toCls
                        //                     });
                        //                     fromCls = undefined;
                        //                     toCls = undefined;
                        //                 }
                        //                 //   if(!that.belongsToForbiden(element.o.value))
                        //                 //   {
                        //                 //     console.log(element.o.value);
                        //                 //     visDisplay.addNode(element.o.value);
                        //                 //   }
                        //                 //
                        //                 // if(element.p.token === 'uri')
                        //                 // if(!that.belongsToForbiden(element.p.value))
                        //                 // {
                        //                 //   console.log(element.p.value);
                        //                 //   console.log(elm);
                        //                 //   visDisplay.createEdgeBetween(elm, element.o.value, element.p.value);
                        //                 // }
                        //             });
                        //
                        //             console.log(fromToArray);
                        //             // console.log(results);
                        //             //   // process results
                        //             //   if (results[0].p.token === 'uri')
                        //             //   {
                        //             //       console.log(results);
                        //             //   }
                        //         }
                        //         else
                        //         {
                        //             console.log(err);
                        //         }
                        //      });
                        //     visDisplay.redrawNetwork();
                        // //});
                    },

                    _addNodes: function(classes)
                    {
                      var visDisplay = this.$.rdfDisplay;
                      classes.forEach(function(elm)
                      {
                          visDisplay.addNode(elm, elm);
                      });
                    },
                    _addEdges: function(properties)
                    {
                      var visDisplay = this.$.rdfDisplay;

                      for(var label in properties)
                      {
                        if(properties[label][0] != undefined && properties[label][1] != undefined)
                        {
                          properties[label][0].forEach(function(p0){
                            properties[label][1].forEach(function(p1){
                              visDisplay.createEdgeBetween(p0,p1,label);
                            });
                          });
                        }
                      }
                    },
                    belongsToForbiden: function(elmt)
                    {
                        return dumpedURI.includes(elmt);
                    },
                    isDomain: function(elmt)
                    {
                        return domainURI.includes(elmt);
                    },
                    isRange: function(elmt)
                    {
                        return rangeURI.includes(elmt);
                    },
                    propertieIsParsed: function(prop, props)
                    {
                        for (var p in props)
                        {
                            if (p === prop)
                                return true;
                        }
                        return false
                    },
                });
            })();
    </script>
</dom-module>
