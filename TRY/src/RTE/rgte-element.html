<!-- Relation Graph of Traced Element -->

<link rel="import" href="../wrapper/vis-element.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../RTE/rgte-displayer-element.html">
<link rel="import" href="../RTE/rgte-cardinality-form-element.html">

<dom-module id="rgte-element">
    <template>
        <style>
             :host {
                display: block;
            }
        </style>

        <!-- <vis-element id="rgte" network="{{network}}" , nodes="{{nodes}}" edges="{{edges}}"></vis-element> -->
        <div  hidden$="{{ !isWaitingPropertyBinding }}">
        <paper-card>
          <div class="card-content">A property is waiting to be bound</div>
          <!-- <div class="card-actions"></div> -->
        </paper-card>
      </div>


        <rgte-displayer-element id="rgteview" rgte="{{rgte}}"></rgte-displayer-element>

        <paper-dialog on-iron-overlay-closed="_isAddPropertyConfirmed" id="propertyModal" modal>
            <h2>Bind the property</h2>
            <p>Please choose the two nodes that will be linked with the selected property. First is the domain, the second the range.</p>
            <div class="buttons">
                <paper-button dialog-dismiss>Decline</paper-button>
                <paper-button dialog-confirm autofocus>Accept</paper-button>
            </div>
        </paper-dialog>

        <paper-dialog id="propertyIsWaiting" modal>
            <h2>Property is waiting</h2>
            <p>A property is currently waiting to be bound. Please select the remaining nodes.</p>
            <div class="buttons">
                <paper-button dialog-confirm autofocus>Ok</paper-button>
            </div>
        </paper-dialog>

        <paper-dialog id="NotEnoughNodes" modal>
            <h2>More nodes are needed</h2>
            <p>You don't have enough nodes in your RGTE in order to applying this property. First, add more nodes.</p>
            <div class="buttons">
                <paper-button dialog-confirm autofocus>Ok :'(</paper-button>
            </div>
        </paper-dialog>


        <div hidden$="{{ disableCardinality }}">
          <rgte-cardinality-form-element id="rgteCard" rgte="{{rgte}}" edgeid="{{edgeIDSelected}}"></rgte-cardinality-form-element>
        </div>

    </template>
    <script>
    (
      function()
      {
        var NODE = 0;
        var EDGE = 1;

        Polymer(
        {
            is: 'rgte-element',

            properties:
            {
                isWaitingPropertyBinding:
                {
                    type: Boolean,
                    value: false,
                    notify: true,
                    // observer: '_oniWPBChanged',
                },
                propertyToBind:
                {
                    type: Object,
                    value: null,
                },
                rgte:
                {
                  type: Object,
                  value: function(){
                    return new RGTE();
                  },
                  notify: true,
                  // observer: "_test"
                },

                edgeIDSelected:
                {
                  type: Number,
                  value: -1,
                  notify: true,
                },

                propAsyncBuild:
                {
                  type: Object,
                  value: function(){return new PropertyAsyncrhonousBuilder();},
                  notify: true,
                },
                disableCardinality:
                {
                  type: Boolean,
                  value: false,
                  notify: true,
                },
            },

            attached: function()
            {
                this.$.rgteview.addEventListener('NODE_CLICKED', function(p)
                {
                    this._behaviorSelector(p.detail, NODE);
                }.bind(this));

                this.$.rgteview.addEventListener('EDGE_CLICKED', function(p)
              {
                this._behaviorSelector(p.detail, EDGE);
              }.bind(this));

              this.propAsyncBuild.setFirstObject(this.rgte);
              this.propAsyncBuild.setSecondObject(this.rgte);
              this.propAsyncBuild.setArray(1);
              this.propAsyncBuild.registerObserverCallbackOnCompletion(this, this._callbackPropertyBindingComplete)
            },


            addClass: function(cls) //From rte-lister-element redirected by rgte-workzone-element
            {
                this.rgte.addVisNode(cls);
            },


            addProp: function(prop)
            {
                if (this.isWaitingPropertyBinding)
                {
                    this.$.propertyIsWaiting.open();
                    return;
                }

                if (this.rgte.getNodes().length < 2)
                {
                    this.$.NotEnoughNodes.open();
                    return;
                }

                this.propertyToBind = prop;
                this.$.propertyModal.open();
            },

            _isAddPropertyConfirmed: function(e) //Modifying RGTE behavior
                {
                    if (e.detail.confirmed)
                    {
                        this.isWaitingPropertyBinding = true;
                    }
                    else
                    { //Otherwise the user don't want to bind prop, thus it has to be reset
                        this.propertyToBind = null;
                        this.isWaitingPropertyBinding = null;
                        // this.nodeDomain = null;
                        // this.nodeRange = null;
                    }
                },

                _callbackPropertyBindingComplete: function()
                {
                  var prop;
                  var arr = this.propAsyncBuild.getArrayFilled();

                  for(var i in arr)
                    prop = arr[i];

                  prop.from = prop.from.retrieveUniqueIdentifier();//Assured that from has retrieveUniqueIdentifier since it comes from the asyncBuilder
                  prop.to = prop.to.retrieveUniqueIdentifier();
                  this.rgte.addVisProperty(prop, "to");

                  this.propAsyncBuild.reset();

                  this.isWaitingPropertyBinding = false;
                },

            //Define the behavior of the RGTE on click
            _behaviorSelector: function(params, type)
            {
              console.log(params);
                if (this.isWaitingPropertyBinding)
                {
                    this._linkingNodesBehavior(params, type);
                }
                else
                {
                    this._defaultRGTEBehavior(params, type);
                }

            },

            //Link the selected property (edge) with two classes (nodes)
            _linkingNodesBehavior: function(params, type)
            {
                if (type === NODE) //il y a au moins un noeud de sélectionné
                {
                    this.propAsyncBuild.bind(this.rgte.getNodeById(params.id), this.propertyToBind.uri, this.propertyToBind.label);
                }
            },

            //Default RGTE behavior is reactivty on edge to allow setting cardinality, discarding. Reactivity on node to allow discarding
            _defaultRGTEBehavior: function(params, type)
            {
                console.log("dRB");
                if (this.isWaitingPropertyBinding) //Don't change the behavior
                    return;

                if (type === NODE)
                {
                    return;
                }
                else if (type === EDGE)
                {
                  console.log("EDGE "+params.id+" selected");
                  this.edgeIDSelected = params.id;
                  // this.rgteEdgeSelected = {"id": params.id, "val": params.edgeLabel};
                }
            },

            // getNetwork: function()
            // {
            //     return this.network;
            // },

            // getEdgesCardinality: function()
            // {
            //     return this.edgesCardinality;
            // },

        });
      })();
    </script>
</dom-module>
