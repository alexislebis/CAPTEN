<link rel="import" href="./rgte-inline-displayer-element.html">

<dom-module id="rgte-search-element">
  <template>
    <style>

    #searchZone{
      @apply(--layout-horizontal);
      margin-bottom: 50px;
    }

    #searchZone paper-searchbox{
      @apply(--layout-flex);
      --paper-searchbox-background: var(--paper-searchbox-dark-background);
      --paper-searchbox-color: black;
    }

    #divRoot{
      width: var(--vis-element-width, 90%);
      margin: 0 auto;
    }

    #new{
      @apply(--layout-vertical);
      @apply(--layout-center);
      margin-bottom: 50px;
    }

    </style>

    <app-location route="{{routeTopLevel}}" use-hash-as-path></app-location>

<div id="divRoot">

  <div id="fabRewind" hidden$={{!enableRewind}}>
    <paper-fab icon="icons:reply" on-click="_goBack"></paper-fab>
  </div>

  <div id="new">
    <paper-button raised on-click="_openNew">Create a new relational graph of concepts</paper-button>
  </div>

    <div id="searchZone" hidden="{{_computeHiddenAssumption(itemElmt)}}">
      <paper-searchbox raise-forced="true" placeholder="Search graph" value="{{query}}"></paper-searchbox>
      <paper-button raised disabled>Show search options</paper-button>
    </div>

  <div id="result">
    <div id="relatedGraph"> <!-- Graph form the steps-->
      <header class="headerSubSection">
        <div on-click="_toggleCollapseStepRGTE">
          <span><h3>Graphs from previous steps (current NAP)</h3></span>
          <paper-icon-button id="stepRGTEpib" icon="expand-more"></paper-icon-button>
        </div>
      </header>
      <template id="repeaterRelated" is="dom-repeat" items="{{rgteRelated}}" index-as="index" restamp>
          <rgte-inline-displayer-element enable-use="{{enableUse}}" rgte="{{item}}"><rgte-inline-displayer-element>
      </template>
    </div>

    <div id="normal">
      <header class="headerSubSection">
        <div on-click="_toggleCollapseAllRGTE">
          <span><h3>{{_computeHeaderName(query)}}</h3></span>
          <paper-icon-button id="allRGTEpib" icon="expand-more"></paper-icon-button>
        </div>
      </header>
  <!--  -->
      <iron-collapse id="collapseAR">
        <template id="repeater" is="dom-repeat" items="{{rgteArray}}" filter="{{computeFilter(query)}}" index-as="index" restamp>
            <rgte-inline-displayer-element enable-use="{{enableUse}}" rgte="{{item}}"><rgte-inline-displayer-element>
        </template>
      </iron-collapse>

    </div>
    <div id="previous">
      <header class="headerSubSection">
        <div><span>Previous graphs used</span></div>
      </header>
    </div>
    <div>
      <header class="headerSubSection">
        <div><span>Suggested graphs</span></div>
      </header>
    </div>
  </div>
</div>

  </template>
  <script>
    Polymer(
    {
      is: 'rgte-search-element',

      properties:{
        rgteArray:
        {
          type: Object,
          notify: true,
        },

        rgteRelated:
        {
          type: Object,
          notify: true,
        },

        routeTopLevel: Object,

        query : String,

        enableRewind:
        {
          type: Boolean,
          value: false,
          notify: true,
        }
      },

      // observers: [
      //   "_onRouteChanged(route)",
      // ],

      _openNew: function()
      {
        this.set('routeTopLevel.path', '/rgte/new');
      },

      attached: function()
      {
        //@HACK force dom repeat redraw
        this.rgteArray = [];
        this.$.repeater.render();
        //===

        this.rgteArray = RGTE_POOL.getPool();

        this.$.repeater.render();
      },

      update: function()
      {
        //@HACK force dom repeat redraw
        this.rgteArray = [];
        this.$.repeater.render();
        //===

        if(this.nap != null && (this.nap instanceof NarratedAnalysisProcess))//Find associated rgte
        {
          //For each step, find output
          console.log("TODO");
        }


        //@HACK force consideration of new rgte elements. Very intensive
        var a = RGTE_POOL.getPool();

        for(var i = 0; i < a.length; i++)
          this.push("rgteArray", a[i]);

      },

      computeFilter: function(query)
      {
        if(!query || query == null)
          return null;
        else {
          query = query.toLowerCase();
          return function(item){
            return (item.usualName.toLowerCase().includes(query));
          };
        }
      },

      _updateOperationsArray: function()
      {
        // this.operationsArray = [];
        // this.set('operationsArray', NARRATED_OPERATION_POOL.getAvailableOperations());
      },

      _computeHeaderName: function(query)
      {
        return query.length == 0 ? 'All Relational Graphs' : 'Search results';
      },

      _goBack: function()
      {
        this.fire(RGTE_REWIND_REQUESTED_SIGNAL_ID);
      },


      // === COLLAPSER
      _toggleCollapseAllRGTE: function()
      {
        this.$.collapseAR.toggle();
        if(this.$.collapseAR.opened)
          this.$.allRGTEpib.setAttribute('icon', 'icons:expand-less');
        else
          this.$.allRGTEpib.setAttribute('icon', 'icons:expand-more');
      },
      _toggleCollapseStepRGTE: function()
      {
        this.$.collapsePS.toggle();
        if(this.$.collapsePS.opened)
          this.$.stepRGTEpib.setAttribute('icon', 'icons:expand-less');
        else
          this.$.stepRGTEpib.setAttribute('icon', 'icons:expand-more');
      }

    });
  </script>
</dom-module>
