<link rel="import" href="../rdf-data-store/rdf-store-lister-element.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="./rte-formulaire-element.html">
<link rel="import" href="./rgte-custom-class-relation-element.html">


<dom-module id="rte-lister-element">
    <template>
        <style>
            :host {
                font-family: sans-serif;
            }

            .content {
                @apply(--layout-vertical);
                height: 100%;
            }

            .pad {
                @apply(--layout-flex);
                @apply(--layout-vertical);
                padding: 0 16px;
            }

            .item {
                @apply(--layout-horizontal);
                cursor: pointer;
                padding: 16px 22px;
                border-bottom: 1px solid #DDD;
            }

            .item:focus,
            .item.selected:focus {
                outline: 0;
                background-color: #ddd;
            }

            .item.selected .star {
                color: var(--paper-blue-600);
            }

            .item .star {
                color: var(--paper-blue-600);
            }

            .star {
                width: 24px;
                height: 24px;
            }

            .makeRelation {
              color: var(--paper-green-500);
            }

            .removeElmt {
                color: var(--paper-red-600);
                width: 26px;
                height: 26px;
            }

            .removeElmt:hover {
                background-color: var(--paper-red-600);
                color: white;
            }

            .addToRTE{
              color: var(--paper-blue-600);
              width: 24px;
              height: 24px;
              -webkit-transition: all 0.5s ease; /* For Safari 3.1 to 6.0 */
              transition: all 0.5s ease;
            }

            .addToRTE:hover{
              -ms-transform: rotate(90deg); /* IE 9 */
              -webkit-transform: rotate(90deg); /* Chrome, Safari, Opera */
              transform: rotate(90deg);
            }

            .hidden{
              display: none;s
            }

            iron-list {
                @apply(--layout-flex);
            }
        </style>

        <rte-formulaire-element id="rteform" classes="{{mergedCls}}" props="{{mergedProps}}"></rte-formulaire-element>

        <div hidden="{{hideClassRelationForm}}">
          <rgte-custom-class-relation-element id="customRel" vocab="{{vocab}}" customcls="{{customcls}}" customproprs="{{customprops}}" rgte="{{rgte}}" selectedcls="{{selectedcls}}"></rgte-custom-class-relation-element>
        </div>

        <div class$="[[_isCLSSelected(selectedcls)]]">
          <p>Selected class (node): [[selectedcls.uri]]<iron-icon icon="add-circle" on-tap="_addClassToRGTE" class="addToRTE">add-circle</iron-icon></p>
        </div>
        <div class$="[[_isPROPSelected(selectedprop)]]">
          <p>Selected property (edge): [[selectedprop.uri]]<iron-icon icon="add-circle" on-tap="_addPropToRGTE" id="propRGTE" class="addToRTE">add-circle</iron-icon></p>
        </div>

        <div>
            <h2>Custom Classes</h2>
            <!-- <ul id="rdfClasses"></ul> -->
            <iron-list id="ilCUSTCLS" items="[[customcls]]" as="item" class="flex" selection-enabled>
                <template>
                    <div>
                        <div class$="[[_computeClass(selected)]]" on-tap="_custcTapped">
                            <div class="primary pad" tabindex$="[[tabIndex]]">[[item.uri]]</div>
                            <div class="selectedItem">
                                <iron-icon icon$="[[iconForItem(selected)]]" class="star"></iron-icon>
                            </div>
                        </div>
                        <iron-icon class="makeRelation" icon="swap-vert" on-tap="_makeRel"></iron-icon>
                        <iron-icon class="removeElmt" icon="clear" on-tap="_removeCustomCLS"></iron-icon>
                        <div class="border"></div>
                    </div>
                </template>
            </iron-list>
        </div>

        <div>
            <h2>Custom Properties</h2>
            <iron-list id="ilCUSTPROPS" items="[[customprops]]" as="item" class="flex" selection-enabled>
                <template>
                    <div>
                        <div class$="[[_computeClass(selected)]]" on-tap="_custpTapped">
                            <div class="primary pad" tabindex$="[[tabIndex]]">[[item.uri]]</div>
                            <div class="selectedItem">
                                <iron-icon icon$="[[iconForItem(selected)]]" class="star"></iron-icon>
                            </div>
                        </div>
                        <iron-icon class="removeElmt" icon="clear" on-tap="_removeCustomProp"></iron-icon>
                        <div class="border"></div>

                      </div>
                </template>
            </iron-list>
        </div>

        <rdf-store-lister-element id="lister" vocab="{{vocab}}"></rdf-store-lister-element>

    </template>
    <script>
        Polymer(
        {
            is: 'rte-lister-element',

            properties:
            {
                // store:
                // {
                //     type: Object,
                //     value: function()
                //     {
                //         return {};
                //     },
                //     notify: true,
                //     // observer: "_rdfStoreChanged",
                // },
                // graph:
                // {
                //     type: Object,
                //     value: function()
                //     {
                //         return {};
                //     },
                //     // reflectToAttribute: true,
                //     //observer: "_onGraphChanged",
                //     notify: true,
                // },
                // graphuri: //@REMOVE
                // {
                //     type: Object,
                //     value: function()
                //     {
                //         return {};
                //     },
                //     notify: true,
                // },
                customcls:
                {
                    type: Array,
                    notify: true,
                    value: function()
                    {
                        return [];
                    },
                },
                customprops:
                {
                    type: Array,
                    notify: true,
                    value: function()
                    {
                        return [];
                    },
                },
                selectedcls://Class selected
                {
                  type: Object,
                  notify: true,
                  value: null,
                },
                selectedprop:
                {
                  type: Object,
                  notify: true,
                  value: null,
                },
                vocab:
                {
                  type: Object,
                  value: function(){return new CONTROLLED_VOCABULARY();},
                },

                rgte:
                {
                  type: Object,
                  value: function(){ return new RGTE();},
                },

                hideClassRelationForm:
                {
                  type: Boolean,
                  value: true,
                },
            },

            observers: [
                "_onCustomClsChanged(customcls.splices)",
                "_onCustomPropsChanged(customprops.splices)"
            ],

            attached: function()
            {
                this.$.rteform.addEventListener('newElementToAdd', function(e)
                {
                    this._parseNewElement(e);
                }.bind(this));

                this.$.lister.addEventListener('ClassSelected', function(e){
                  this._manageSelectedClass(e)
                }.bind(this));

                this.$.lister.addEventListener('PropSelected', function(e){
                  this._manageSelectedProp(e);
                }.bind(this));

                this.$.lister.addEventListener('ClassDeselected', function(e){
                  //this.$.ilCUSTCLS.clearSelection();
                  this.selectedcls = null;
                }.bind(this));

                this.$.lister.addEventListener('PropDeselected', function(e){
                  //this.$.ilCUSTPROPS.clearSelection();
                  this.selectedprop = null;
                }.bind(this));
            },

            _addClassToRGTE: function(e)
            {
              this.fire("-ClassAddedToRGTE", {val:this.selectedcls});
            },

            _addPropToRGTE: function(e)
            {
              this.fire("-PropAddedToRGTE", {val:this.selectedprop});
            },

            _parseNewElement: function(e)
            {
                if (e.detail.type === "CLASS") //Si il s'agit d'une classe
                {
                    if (!this.customcls.includes(e.detail.value) && !this.vocab.getClasses().includes(e.detail.value))
                        this.addCustomClass(e.detail.value);
                }
                else if (e.detail.type === "PROPERTY")
                {
                    if (!this.customprops.includes(e.detail.value) && !this.vocab.getURIProperties().includes(e.detail.value))
                        this.addCustomProperty(e.detail.value);
                }

            },
            addCustomClass: function(cClass)
            {
                if (cClass == undefined && Object.keys(cClass).length === 0 && cClass.constructor === Object)
                    return;

                this.push('customcls', new CAPTENClass(cClass, cClass));
            },
            addCustomProperty: function(cProp)
            {
                if (cProp == undefined && Object.keys(cProp).length === 0 && cProp.constructor === Object)
                    return;

                this.push('customprops', new Property(cProp, cProp));
            },

            iconForItem: function(isSelected)
            {
                return isSelected ? 'check-circle' : 'radio-button-unchecked';
            },

            _computeClass: function(isSelected)
            {
                return isSelected ? 'item selected' : 'item';
            },

            _custcTapped: function(e)
            {
                this.$.lister.clearClsSelection();

                if(!e.model.selected)
                  this.selectedcls = e.model.item;
                else
                  this.selectedcls = null;

                this.hideClassRelationForm = true;
            },
            _custpTapped: function(e)
            {
                this.$.lister.clearPropSelection();

                if(!e.model.selected){
                  this.selectedprop = e.model.item;
                  console.log(this.selectedprop);
                }
                else {
                  this.selectedprop = null;
                }
            },

            _onCustomClsChanged: function(change)
            {

                if (Object.keys(this.customcls).length === 0 && this.customcls.constructor === Object)
                    return;

                if (!change)
                    return;

                // this._mergingCls();

                Polymer.dom(this.root).querySelector('#ilCUSTCLS').notifyResize();
            },
            _onCustomPropsChanged: function(change)
            {
                if (Object.keys(this.customprops).length === 0 && this.customprops.constructor === Object)
                    return;

                if (!change)
                    return;

                // this._mergingProps();

                Polymer.dom(this.root).querySelector('#ilCUSTPROPS').notifyResize();
            },
            _removeCustomCLS: function(e)
            {
                var index = this.customcls.indexOf(e.model.item);

                if(this.selectedcls === this.customcls[index])
                  this.selectedcls = null;

                this.splice('customcls', index, 1);

                // this._mergingCls();
                //
                // Polymer.dom(this.root).querySelector('#ilCUSTCLS').notifyResize();
            },
            _removeCustomProp: function(e)
            {
                var index = this.customprops.indexOf(e.model.item);

                if(this.selectedprops === this.customprops[index])
                  this.selectedprops = null;

                this.splice('customprops', index, 1);

                // this._mergingProps();
                //
                // Polymer.dom(this.root).querySelector('#ilCUSTPROPS').notifyResize();
            },

            _isCLSSelected: function(cls)
            {
              return (cls === undefined || cls === null) ? "hidden":"noHidden";
            },

            _isPROPSelected: function(prop)
            {
              return (prop === undefined || prop === null) ? "hidden":"noHidden";
            },


            _manageSelectedClass: function(e)
            {
              this.$.ilCUSTCLS.clearSelection();

              // if(!e.detail.element.model.selected)
                this.selectedcls = e.detail;

            },
            _manageSelectedProp: function(e)
            {
              this.$.ilCUSTPROPS.clearSelection();

              // if(!e.detail.element.model.selected)
              this.selectedprop = e.detail;
            },

            _makeRel: function(e)
            {
              if(this.selectedcls == null)
                return ;

              this.$.customRel.update();
              this.hideClassRelationForm = false;
            },
        });
    </script>
</dom-module>
