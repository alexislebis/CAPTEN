<link rel="import" href="import/tools-import.html">
<link rel="import" href="wrapper/capten-onto-model-element.html">

<link rel="import" href="APE/steps/step-relation-tab-element.html">

<link rel="import" href="import/composite-element-import.html">

<link rel="import" href="APE/operators/operator-creation-page-element.html">
<link rel="import" href="APE/ape-element.html">
<link rel="import" href="APE/operation-search-element.html">
<link rel="import" href="APE/operation-search-page-element.html">
<link rel="import" href="APE/steps/step-card-element.html">
<link rel="import" href="APE/steps/new-step-card-element.html">
<link rel="import" href="APE/steps/step-creation-page-element.html">
<link rel="import" href="APE/steps/steps-overview-element.html">
<link rel="import" href="APE/analysis/analysis-creation-page.html">

<link rel="import" href="RTE/rte.html">
<link rel="import" href="RTE/rgte-search-element.html">
<link rel="import" href="RTE/rgte-find-similar-element.html">
<link rel="import" href="RTE/rgte-page-element.html">

<link rel="import" href="VOOG/voog.html">
<link rel="import" href="./Vocabulary/vocabulary-lister-element.html">
<link rel="import" href="./Vocabulary/terminology-element.html">

<link rel="import" href="wrapper/vis-element.html">
<link rel="import" href="wrapper/narrative-block-model-element.html">

<link rel="import" href="wrapper/capten-onto-namer-wrapper-element.html">

<link rel="import" href="./GeneralPurpose/view/history/history-displayer.html">
<link rel="import" href="import/capten-loader-import.html">
<link rel="import" href="./GeneralPurpose/CAPTENLoader.html">


<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../../bower_components/paper-toast/paper-toast.html">

<!-- THEMES -->
  <link rel="import" href="GeneralPurpose/view/theme/toasty-style.html">



<dom-module id="main-seed">
  <template>
    <style include="toasty-style"></style>
    <style>
      :host {
        display: block;
      }

      #rootDiv{
        display: block;
        position: relative;
      }
    </style>

<div id="rootDiv">
    <app-location use-hash-as-path route="{{route}}"></app-location>
    <!-- <app-route route="{{route}}" pattern="/tabs" tail="{{tabsRoute}}" active="{{tabsActive}}"></app-route>
      <app-route route="{{tabsRoute}}" pattern="/:tabName" data="{{data}}"></app-route>
    <app-route route="{{route}}" pattern="/vocabulary" active="{{vocabularyActive}}"></app-route> -->

    <app-route route="{{route}}" pattern="/:topLevel" active="{{active}}" data="{{routeData}}" tail="{{tailTopLevel}}"></app-route>

      <!-- <app-route route="{{tailTopLevel}}" prefix="/tabs" pattern="/:tabName" active="{{activeTabs}}" data="{{dataTabs}}"></app-route> -->
        <!-- <app-route route="{{tail}}" pattern="/:tabName" active="{{active}}" data="{{data}}" tail="{{tail}}"></app-route> -->




    <paper-tabs selected='{{routeData.topLevel}}'  fit-container attr-for-selected="name">
            <paper-tab name="rgte">RTE</paper-tab>
            <paper-tab name="voog">VOOG</paper-tab>
            <paper-tab name="ape">APE</paper-tab>
    </paper-tabs>

    <!-- <history-displayer></history-displayer> -->

    <paper-icon-button icon="save" on-click="export"></paper-icon-button>
    <capten-loader-element vocab="{{vocab}}" customcls="{{customcls}}" customprops="{{customprops}}"></capten-loader-element>

    <neon-animated-pages selected='{{routeData.topLevel}}'
                     attr-for-selected='name'
                     entry-animation='scale-up-animation'
                     exit-animation='slide-right-animation'>
      <neon-animatable name='rgte'><div name="rte" ><rgte-page-element id="rteElem" route="{{tailTopLevel}}" vocab="{{vocab}}" customcls="{{customcls}}" customprops="{{customprops}}"></rgte-page-element></div></neon-animatable>
      <neon-animatable name='voog'><div name="voog"><main-voog></main-voog></div></neon-animatable>
      <neon-animatable name='ape'><div name="ape"><ape-element id="apeElem" rgtes="{{rgtes}}" vocab="{{vocab}}" customcls="{{customcls}}" customprops="{{customprops}}"></ape-element></div></neon-animatable>
      <neon-animatable name='vocabulary'><vocabulary-lister-element route="{{tailTopLevel}}" vocab="{{vocab}}" customcls="{{customcls}}" customprops="{{customprops}}"></vocabulary-lister-element></neon-animatable>
      <neon-animatable name='terminology'><terminology-element route="{{tailTopLevel}}" rgte="{{rgte}}" rgtes="{{rgtes}}" vocab="{{vocab}}" customcls="{{customcls}}" customprops="{{customprops}}"></terminology-element></neon-animatable>
      <neon-animatable name='rgte_search'><rgte-search-element></rgte-search-element></neon-animatable>
      <neon-animatable name='rgte_similar'><rgte-find-similar-element></rgte-find-similar-element></neon-animatable>
      <neon-animatable name="nop"><operator-creation-page-element route-top-level="{{route}}" route="{{tailTopLevel}}" vocab="{{vocab}}" customcls="{{customcls}}" customprops="{{customprops}}"></operator-creation-page-element></neon-animatable>
      <neon-animatable name="operation_search"><operation-search-page-element route="{{route}}"></operation-search-page-element></neon-animatable>
      <neon-animatable name="step"><step-creation-page-element route="{{tailTopLevel}}" vocab="{{vocab}}" customcls="{{customcls}}" customprops="{{customprops}}"></step-creation-page-element></neon-animatable>
      <neon-animatable name="analysis"><analysis-creation-page route="{{tailTopLevel}}" nap="{{nap}}" vocab="{{vocab}}" customcls="{{customcls}}" customprops="{{customprops}}"></analysis-creation-page></neon-animatable>
      <neon-animatable name="narration"><narrative-creation-page-element route="{{tailTopLevel}}" vocab="{{vocab}}" customcls="{{customcls}}" customprops="{{customprops}}"><narrative-creation-page-element></neon-animatable>
    </neon-animated-pages>


    <!-- <narrative-block-cascader-display-element id="rootNarrativeBlockDisplayer" entity="{{narrativeentity}}"></narrative-block-cascader-display-element> -->
    <div hidden="{{_isNarrativeEntityIsEmpty(narrativeentity)}}">
      <narrative-block-cascading-element id="rootNarrativeBlockDisplayer"></narrative-block-cascading-element>
    </div>

    <paper-toast id="toastNewFocus" text="New element focused ({{narrativeentity.htmlify}})">
      <paper-button  on-click="_rollbackNarrativeEntity" class="toastButton">UNDO</paper-button>
    </paper-toast>

    <paper-toast id="toastAddBag" text='Graph copied to the "APE" section'>
      <paper-button on-click="_rollbackBagAdd" class="toastButton">UNDO</paper-button>
    </paper-toast>

    <paper-toast id="toastGoBack" text="You can't go back this way. Use the menu instead">
      <paper-button on-click="_closeToast" class="toastButton">UNDO</paper-button>
    </paper-toast>

    <!-- MODAL -->
    <paper-dialog on-iron-overlay-closed="_confirmPrevious" id="modalConfirmationPrevious" modal>
        <h2>Unsaved modification</h2>
        <p>Your modification will be lost if you go back. Do you still want to proceed?</p>
        <div class="buttons">
            <paper-button dialog-dismiss>No</paper-button>
            <paper-button dialog-confirm autofocus>Yes, go back</paper-button>
        </div>
    </paper-dialog>

    <h1>{{data.page}}</h1>
</div>
  </template>
  <script>
    Polymer({
      is: 'main-seed',

      properties:
      {
        data: String,
        tabsRoute: String,
        tabsActive: String,

        rgtes:{
          type: Array,
          notify: true,
          value: function(){return [];},
        },

        vocab:
        {
          type: Object,
          value: function(){ return new CONTROLLED_VOCABULARY();},
        },
        customcls://used for file-reader
        {
            type: Array,
            notify: true,
            value: function()
            {
                return [];
            },
        },
        customprops:
        {
            type: Array,
            notify: true,
            value: function()
            {
                return [];
            },
        },

        narrativeentity:
        {
          type: Object,
          notify: true,
          value: null,
        },

        // === TOASTY
          previousNarrativeEntity:
          {
            type: Object,
            notify: true,
          },
          previousRGTE:
          {
            type: Object,
            notify: true,
          },

      },

      _routeChanged: function(changeRecord) {
        if (changeRecord.path === 'path') {
          console.log('Path changed!');
        }
      },

      export: function(link)
      {

        var ser = {header: "", narratives: null, graphs: null, operations: null, vocab: null, properties: null};

        ser.header = "Generated by the CAPTEN (version 0.0.2.20170703-1411) https://github.com/alexislebis/CAPTEN\nPrototypal Version with temporary EXPORT";

        ser.narratives = NARRATIVE_BLOCK_POOL.serializeToJSON();

        ser.graphs = RGTE_POOL.serializeToJSON();

        ser.operations = NARRATED_OPERATION_POOL.serializeToJSON();

        CUSTOM_ENTITIES_HANDLER.setCustoms(this.customcls, this.customprops);
        ser.vocab = CUSTOM_ENTITIES_HANDLER.serializeToJSONN3WithVocabularyIntegration(this.vocab);

        ser.properties = PROPERTIES_POOL.serializeToJSON();

        var res = JSON.stringify(ser);

        var blob = new Blob([res], {type: "application/json"});
        var url  = URL.createObjectURL(blob);

        var a = document.createElement('a');
        a.download    = "CAPTEN_EXPORT.json";
        a.href        = url;
        a.click();

        setTimeout(function(){  // fixes firefox html removal bug
        window.URL.revokeObjectURL(url);
        a.remove();
        }, 500);
        // a.textContent = "CAPTEN EXPORT.json";
        // a.style.display = "none";
        // document.body.appendChild(a);
        // a.click();
        // document.body.removeChild(a);
        // var element = document.createElement('a');
        // element.setAttribute('href', 'data:application/json;charset=utf-8,' + res);
        // element.setAttribute('download', "CAPTEN_EXPORT.json");
        //
        // element.style.display = 'none';
        // document.body.appendChild(element);
        //
        // element.click();
        //
        // document.body.removeChild(element);
      },

      attached: function()
      {
        HISTORY_MANAGER.registerObserverCallbackOnFail(this, this._openToastFailure);
        HISTORY_MANAGER.setVocabulary(this.vocab, this.customcls, this.customprops);
        CUSTOM_ENTITIES_HANDLER.setCustoms(this.customcls, this.customprops);
        // HISTORY_MANAGER.stack(new Step());

        this.$.rteElem.addEventListener("-RGTEAddedToTheBag", function(e)
        {
          // console.log("WARNING: Currently, only one RGTE can be used simultaneously.");//TODO
          // this.rgtes = [];
          this.previousRGTE = e.detail.copy();//Copy for new edition

          this.push('rgtes', this.previousRGTE);

          this.$.toastAddBag.open();

        }.bind(this));

        this.$.apeElem.addEventListener(NARRATIVE_BLOCK_NOTIFY_SIGNAL_ID, function(e)
        {
          this.previousNarrativeEntity = this.narrativeentity;
          this.narrativeentity = e.detail.entity;
          this.$.toastNewFocus.open();
          Polymer.dom(this.root).querySelector('#rootNarrativeBlockDisplayer').setEntity(e.detail.entity);
        }.bind(this));

        window.addEventListener(HISTORY_PREVIOUS_REQUESTED_SIGNAL_ID, function(e)
        {
            if( (
                  e.data.current instanceof NarratedOperator ||
                  e.data.current instanceof NarratedAnalysisProcess ||
                  e.data.current instanceof Step
                ) &&
                  !e.data.current.isRegistered
              )
             {
               this.eventPrevious = e;
               this.$.modalConfirmationPrevious.open();
             }
             else
              e.data.callback(e.data.initialEvent);

        }.bind(this));

      },

      _confirmPrevious: function(e)
      {
        if(!this.eventPrevious)
          return;

        if(e.detail.confirmed)
        {
          this.eventPrevious.data.callback(this.eventPrevious.data.initialEvent);
        }
        else
          this.eventPrevious.data.callbackFail(this.eventPrevious.data.initialEvent);
      },

      _isNarrativeEntityIsEmpty: function(nEntity)
      {
        if(nEntity == null)
          return true;
        else
          return false;
      },

      _rollbackNarrativeEntity: function()
      {
        if(this.previousNarrativeEntity == null)
          return;

        this.$.toastNewFocus.close();
        this.narrativeentity = this.previousNarrativeEntity;
        Polymer.dom(this.root).querySelector('#rootNarrativeBlockDisplayer').setEntity(this.narrativeentity);
      },

      _rollbackBagAdd: function()
      {
        if(this.previousRGTE == null)
          return;

        var index;
        for(var i in this.rgtes)
          if(this.rgtes[i].id == this.previousRGTE.id)
            index = i;

        if(index == null)
          return;

        this.splice('rgtes', index, 1);
      },

      _openToastFailure: function()
      {
          this.$.toastGoBack.open();
      },

      _closeToast: function(e)
      {
        Polymer.dom(e).localTarget.parentElement.close();
      },

    });
  </script>
</dom-module>
