<link rel="import" href="APE/ape-element.html">
<link rel="import" href="RTE/rte.html">
<link rel="import" href="VOOG/voog.html">
<link rel="import" href="import/tools-import.html">

<link rel="import" href="wrapper/vis-element.html">
<link rel="import" href="wrapper/narrative-block-model-element.html">
<link rel="import" href="wrapper/capten-onto-model-element.html">

<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../../../bower_components/paper-toast/paper-toast.html">

<!-- THEMES -->
  <link rel="import" href="GeneralPurpose/view/theme/toasty-style.html">



<dom-module id="main-seed">
  <template>
    <style include="toasty-style"></style>
    <style>
      :host {
        display: block;
      }
    </style>

    <app-location use-hash-as-path route="{{route}}"></app-location>
    <app-route route="{{route}}" pattern="/tabs" tail="{{tabsRoute}}" active="{{tabsActive}}"></app-route>
    <app-route route="{{tabsRoute}}" pattern="/:tabName" data="{{data}}"></app-route>

    <paper-tabs selected='{{data.tabName}}'  fit-container attr-for-selected="name">
            <paper-tab name="rte">RTE</paper-tab>
            <paper-tab name="voog">VOOG</paper-tab>
            <paper-tab name="ape">APE</paper-tab>
    </paper-tabs>

    <iron-pages selected='{{data.tabName}}' attr-for-selected="name">
      <div name="rte" ><main-rte id="rteElem" vocab="{{vocab}}" customcls="{{customcls}}" customprops="{{customprops}}"></main-rte></div>
      <div name="voog"><main-voog></main-voog></div>
      <div name="ape"><ape-element id="apeElem" rgtes="{{rgtes}}" vocab="{{vocab}}" customcls="{{customcls}}" customprops="{{customprops}}"></ape-element></div>
    </iron-pages>

    <!-- <narrative-block-cascader-display-element id="rootNarrativeBlockDisplayer" entity="{{narrativeentity}}"></narrative-block-cascader-display-element> -->
    <narrative-block-cascading-element id="rootNarrativeBlockDisplayer"></narrative-block-cascading-element>


    <paper-toast id="toastNewFocus" text="New element focused ({{narrativeentity.htmlify}})">
      <paper-button  on-click="_rollbackNarrativeEntity" class="toastButton">UNDO</paper-button>
    </paper-toast>

    <paper-toast id="toastAddBag" text='Graph copied to the "APE" section'>
      <paper-button on-click="_rollbackBagAdd" class="toastButton">UNDO</paper-button>
    </paper-toast>

    <h1>{{data.page}}</h1>

  </template>
  <script>
    Polymer({
      is: 'main-seed',

      properties:
      {
        data: String,
        tabsRoute: String,
        tabsActive: String,

        rgtes:{
          type: Array,
          notify: true,
          value: function(){return [];},
        },

        vocab:
        {
          type: Object,
          value: function(){ return new CONTROLLED_VOCABULARY();},
        },
        customcls://used for file-reader
        {
            type: Array,
            notify: true,
            value: function()
            {
                return [];
            },
        },
        customprops:
        {
            type: Array,
            notify: true,
            value: function()
            {
                return [];
            },
        },

        narrativeentity:
        {
          type: Object,
          notify: true,
          value: null,
        },

        // === TOASTY
          previousNarrativeEntity:
          {
            type: Object,
            notify: true,
          },
          previousRGTE:
          {
            type: Object,
            notify: true,
          },

      },

      attached: function()
      {
        this.$.rteElem.addEventListener("-RGTEAddedToTheBag", function(e)
        {
          // console.log("WARNING: Currently, only one RGTE can be used simultaneously.");//TODO
          // this.rgtes = [];
          this.previousRGTE = e.detail.copy();//Copy for new edition

          this.push('rgtes', this.previousRGTE);

          this.$.toastAddBag.open();

        }.bind(this));

        this.$.apeElem.addEventListener(NARRATIVE_BLOCK_NOTIFY_SIGNAL_ID, function(e)
        {
          this.previousNarrativeEntity = this.narrativeentity;
          this.narrativeentity = e.detail.entity;
          this.$.toastNewFocus.open();
          Polymer.dom(this.root).querySelector('#rootNarrativeBlockDisplayer').setEntity(e.detail.entity);
        }.bind(this));
      },

      _rollbackNarrativeEntity: function()
      {
        if(this.previousNarrativeEntity == null)
          return;

        this.$.toastNewFocus.close();
        this.narrativeentity = this.previousNarrativeEntity;
        Polymer.dom(this.root).querySelector('#rootNarrativeBlockDisplayer').setEntity(this.narrativeentity);
      },

      _rollbackBagAdd: function()
      {
        if(this.previousRGTE == null)
          return;

        var index;
        for(var i in this.rgtes)
          if(this.rgtes[i].id == this.previousRGTE.id)
            index = i;

        if(index == null)
          return;

        this.splice('rgtes', index, 1);
      },


    });
  </script>
</dom-module>
